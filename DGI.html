<!DOCTYPE html>
<html lang="en">    
    <head>
        <title>verbalization of diagnostic gist information</title>
        <meta charset="UTF-8">
        <meta name="author" content="FailingLeaf">
        <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    </head>
    <body>
        <style>
            body {
                background-color: #808080;
                color: white;
            }
        </style>

        <!-- jsPsych library -->
        <script src="jspsych/jspsych.js"></script>
        <script src="jspsych/plugin-html-keyboard-response.js"></script>
        <script src="jspsych/plugin-html-button-response.js"></script>
        <script src="jspsych/plugin-image-keyboard-response.js"></script>
        <script src="jspsych/plugin-resize.js"></script>
        <script src="jspsych/plugin-preload.js"></script>
        <script src="jspsych/plugin-fullscreen.js"></script>
        <script src="jspsych/plugin-survey-text.js"></script>
        <script src="jspsych/plugin-survey-multi-choice.js"></script>

        <!-- custom js files -->
        <script src="text_dgi.js"></script>
	    <script src="stimnames_LAN.js"></script>

        <!-- main experiment script -->
        <script src="save.js">//saveData function</script>
        <script>
            // initialise jsPsych
            var jsPsych = initJsPsych({override_safe_mode: true});
            
            // Get Sona participant ID
            var sona_id = jsPsych.data.getURLVariable('s');
	        var random_id = jsPsych.randomization.randomID(16);

            // Timeline Variables and Preload
            var sample = jsPsych.data.getURLVariable('c');
            if (typeof sample === 'undefined' || sample === null) {
                console.warn('DEBUG: URL variable "c" (sample) is undefined — defaulting to "1"');
                sample = '1';
            }
        	var timeline_var = window['stimuli_' + sample];
	        var preload_var = window['preload_stimuli_' + sample];

            // Test mode
            var tm = jsPsych.data.getURLVariable('test_mode');
	
	        if(tm==1){
		        var shstims = jsPsych.randomization.shuffle(timeline_var);
		        var timeline_var = shstims.slice(0,4);
	        }
            
            //// Setup ////

            // Preload // preload images
            var preload = {
                type: jsPsychPreload,
                images: preload_var
                
            };

            // Resize
            var resize = {
		      type: jsPsychResize,
		      item_width: 3 + 3/8,
		      item_height: 2 + 1/8,
		      prompt: resize_text,
		      pixels_per_unit: 92,
		      button_label: "Weiter"
	        };

            // Hide mouse cursor
            var hidemouse = {
		        type: jsPsychHtmlKeyboardResponse,
		        stimulus: "<p style='font-size:16px;'>Für den weiteren Verlauf der Studie benötigen Sie nur noch Ihre Tastatur.</p>" +
                "<p style='font-size:16px;'>Drücken Sie die Leertaste, um fortzufahren.</p>",
		        choices: [' ']
            };

            // Welcome message
            var welcome = {
		        type: jsPsychHtmlButtonResponse,
		        stimulus: welcome_text,
		        margin_vertical:'2px',
		        choices:['Weiter','Abbrechen'],
		        on_finish: function(data){
			        if(data.button_pressed == "1"){
				        jsPsych.data.get().addToLast({ID: 'abort'});
				        jsPsych.endExperiment("<div>Sie haben sich entschieden, nicht an dieser Studie teilzunehmen. Keine Ihrer Angaben wurde gespeichert.<br> Um den Vollbild-Modus zu beenden, drücken Sie bitte 'Esc'. Anschließend können Sie das Browser-Fenster schließen.<div/><div><br><br>Vielen Dank!</div>")
                    }
		        }
	        };

            // Consent form
            var consent_info = {
                type: jsPsychHtmlButtonResponse,
                stimulus: consent_information,
                margin_vertical: '2px',
                choices: ['Ich stimme zu', 'Ich stimme nicht zu'],
                on_finish: function(data) {
                    if (data.button_pressed == "1") {
                        jsPsych.data.get().addToLast({ID: 'abort'});
                        jsPsych.endExperiment("<div> style='font-size:18px;'>Leider können Sie nicht an unserer Studie teilnehmen. Wir möchten uns trotzdem für Ihr Interesse bedanken!<br> Um den Vollbild-Modus zu beenden, drücken Sie bitte 'Esc'. Anschließend können Sie das Browser-Fenster schließen.</div>")
                    }
                }
            };

            /// Demographics

            //Age
            var age = {
                type: jsPsychSurveyText,
                questions: [ {prompt: "<p style='font-size:18px;'>Bitte geben Sie Ihr Alter an.<br></p>", rows:1, columns:6, required: true}],
                button_label: "Weiter"
            };

            //Gender
            var options_gender = ["<strong>weiblich</strong>", "<strong>männlich</strong>", "<strong>nicht binär</strong>", "<strong>keine Angabe</strong>"] ;
            var gender = {
                type: jsPsychSurveyMultiChoice,
                questions: [{prompt: "<p style='font-size:18px;'>Bitte geben Sie an, mit welchem geschlecht Sie sich identifizieren:</p>", options: options_gender, required: true}],
                button_label: "Weiter"
            };

            //Native Language
            var language = {
                type: jsPsychSurveyText,
                questions: [{prompt: "<p style='font-size:18px;'>Bitte geben Sie Ihre Muttersprache an.<br></p>", rows:1, columns:30, required: true}],
                button_label: "Weiter"
            };

            //Highest Education Level
            var options_education = ["<strong>Hauptschule</strong>", "<strong>Realschule</strong>", "<strong>(Fach-)Abitur</strong>", "<strong>abgeschlossenes Hochschulstudium</strong>", "<strong>keine Angabe</strong>"] ;
            var education = {
                type: jsPsychSurveyMultiChoice,
                questions: [{prompt: "<p style='font-size:18px;'>Bitte geben Sie Ihren höchsten bisher erreichten Abschluss an:</p>", options: options_education, required: true}],
                button_label: "Weiter"
            };

            // Fullscreen Start
            var fullscreen_start = {
                type: jsPsychFullscreen,
                fullscreen_mode: true,
                message: fullscreen_text,
                button_label: 'Weiter'
            };

            // Exit fullscreen
            var end_fullscreen = {
                type: jsPsychFullscreen,
                fullscreen_mode: false
            };

            //Fokus // focus text Minuten dauer
            var focus = {
                type: jsPsychHtmlButtonResponse,
                stimulus: "<p style='font-size:18px;'>Für unsere Studie ist es wichtig, dass Sie die folgende Aufgabe <strong>ungestört</strong> bearbeiten können (Dauer ca. (x) Minuten). <br>Wir bitten Sie daher, sich für die Bearbeitung der Aufgabe an einen ruhigen Ort zu begeben und Ablenkungen (Handy,<br>Musik, etc.) zu vermeiden. Stellen Sie bitte außerdem sicher, dass Ihr Bildschirm ausreichend hell eingestellt ist und Sie<br>nicht durch beispielsweise direkte Sonneneinstrahlung beim Bearbeiten der Aufgabe gestört werden.</p><p style='font-size:18px;'>Bitte beachten Sie, dass aus Datenschutzgründen alle Ihre Daten gelöscht werden, wenn Sie das Browser-Fenster vor<br>Beenden der Studie schließen. Um die Studie abzuschließen und Versuchspersonenminuten für Ihre Teilnahme zu<br>erhalten, schließen Sie das Fenster bitte erst, wenn Sie das Ende der Studie erreicht haben.</p><p style='font-size:18px;'> <strong>Vielen Dank!</strong></p>"+ "<p style='font-size:18px;'><br><br>Klicken Sie auf 'Ich bin bereit', um mit der Aufgabe zu beginnen.</p>",
                margin_vertical: '2px',
                choices: ["Ich bin bereit.", "Ich kann die Studie gerade nicht ungestört und konzentriert durchführen."],
                on_finish: function(data) {
                    if (data.button_pressed === 1) {
                        jsPsych.data.get().addToLast({ID: 'abort'});
                        jsPsych.endExperiment("<div style='font-size:18px;'>Sie haben gerade keine Möglichkeit, die Studie ungestört durchzuführen?<br> Wir freuen uns, wenn Sie zu einem späteren Zeitpunkt an der Studie teilnehmen.<div/><div style='font-size:18px;'> <br><br>Vielen Dank!<br><br>Drücken Sie 'Esc', um den Vollbild-Modus zu beenden.</div>")
                    }
                }
            };

            // Save Data ----
	        var save_trial = {
		        type: jsPsychHtmlKeyboardResponse,
		        stimulus: "<div style='font-size:16px;'>Daten werden gespeichert...</div>",
		        choices: "NO_KEYS",
		        trial_duration: 3500,
		        on_start: function(){
			        var outfile = "backup/DGI-" + random_id + "_" + sample;
			        saveData(outfile, jsPsych.data.get().csv()); 
			        var outfile2 = "log/DGI-" + random_id + "_" + sona_id;
			        saveData(outfile2, jsPsych.data.get().first(1).csv());
		        }
	        };
	
	        // End screen // link updaten
	        var endscreen = {
		        type: jsPsychHtmlKeyboardResponse,
		        stimulus: function(){
			        var html ="<div style='font-size:16px;'>Ende der Studie. Vielen Dank für Ihre Teilnahme!<br>Bitte klicken Sie auf den Link unten, um Ihre Versuchspersonenminuten zu erhalten.<br><a href='https://uni-frankfurt.sona-systems.com/webstudy_credit.aspx?experiment_id=946&credit_token=bd2cc93a500b48eda5338bf64b9135ae&survey_code=' onclick='location.href=this.href+sona_id;return false;'> Versuchspersonenminuten erhalten</a><br><br>Drücken Sie die Leertaste, um den Vollbild-Modus zu verlassen.</div>";
			        return html;
		        },
		        choices: [' '],
		        on_start: function(){
			        var outfile = "dgi-" + random_id + "_" + sample;
			        saveData(outfile, jsPsych.data.get().csv());  
			        var outfile2 = "log/dgi-" + random_id + "_" + sona_id;
			        saveData(outfile2, jsPsych.data.get().first(1).csv());
		        }
	        };
            	
            // End screen reminder // link updaten
            var endscreen_reminder = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: function(){
                    var html ="<div style='font-size:16px;'>Ende der Studie. Vielen Dank für Ihre Teilnahme!<br>Bitte klicken Sie auf den Link unten, um Ihre Versuchspersonenminuten zu erhalten.<br><a href='link' onclick='location.href=this.href+sona_id;return false;'> Versuchspersonenminuten erhalten</a><br><br>Wenn Sie keine Versuchspersonenminuten brauchen, können Sie das Browserfenster jetzt schließen.</div>";
                    return html;
                },
                choices: [' '],
                on_finish: function () {
                    location.href = "link" + sona_id;
                }
            };

            // Instructions Übung
            var instructions_pre = {
		     type: jsPsychHtmlKeyboardResponse,
		        stimulus: instruction_pre,
		        choices: [' ']
            };    

            // Instructions
            var instructions = {
		     type: jsPsychHtmlKeyboardResponse,
		        stimulus: instruction,
		        choices: [' ']
            };    
	
            // End practice screen
	        var endpractice = {
		        type: jsPsychHtmlKeyboardResponse,
                stimulus: "<p>Ende der Übungsdurchgänge.</p>" +
                    "<p>Drücken Sie die Leertaste, um mit dem eigentlichen Experiment zu beginnen.</p>",
                choices: [' ']
            };

            //// Experiment trials ////

            // Fixation cross
            var fixation = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: '<div style="font-size:60px;text-align:center;">+</div>',
                choices: "NO_KEYS",
                trial_duration: function(){
                    return jsPsych.randomization.sampleWithoutReplacement([1000,1100,1200,1300,1400,1500,1600], 1)[0];
                }
            };

//            // Helper function to get stimulus duration
//            function getDurationFor(sVal) {
//                sVal = Number(sVal);
//                if (!isNaN(sVal)) {
//                    if ([1,4,7,10,13,16].includes(sVal)) return 50;
//                    if ([2,5,8,11,14].includes(sVal)) return 150;
//                    if ([3,6,9,12,15].includes(sVal)) return 250;
//                }
//                return 50;
//            }

//            // Helper function to decrement s
//            function decrementS() {
//                if (!isNaN(s) && s >= 2 && s <= 16) {
//                    s = s - 1;
//                } else {
//                    s = 16;
//                }
//            }

            // Image stimulus with variable duration
            var image = {
                type: jsPsychImageKeyboardResponse,
                stimulus: jsPsych.timelineVariable('image'),
                choices: "NO_KEYS",
                trial_duration: jsPsych.timelineVariable('prestime')
            };


            // Mask
            var mask = {
                type: jsPsychImageKeyboardResponse,
                stimulus: jsPsych.timelineVariable('mask'),
                choices: "NO_KEYS",
                trial_duration: 100
            };

            // Scene Diagnostic
            var scene_diagnostik = {
                type: jsPsychSurveyText,
                questions: [
                    {prompt: 'Um was handelt es sich bei der Szene, die Sie gesehen haben?', rows: 1, columns: 50, required: true}
                ],
                button_label: "Weiter",
                save_timeline_variables: true,
                data: jsPsych.timelineVariable('data'),
                on_finish: function(data){
                    data.confidence = data.response;
                    data.task = "scene_diagnostic";
                }
            };

            // Confidence in Diagnostic
            var confidence_sd = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: confidence_sd_text,
                choices: ['1','2','3','4','5','6'],
                save_timeline_variables: true,
                data: jsPsych.timelineVariable('data'),
                on_finish: function(data){
                    data.confidence = data.response;
                    data.task = "confidence_sd";
                }
            };

            // Reasoning Diagnostic
            var reasoning_sd = {
                type: jsPsychSurveyText,
                questions: [
                    {prompt: 'Woran haben sie erkannt, um was für eine Szene es sich handelt?', rows: 5, columns: 50, required: true}
                ],
                button_label: "Weiter",
                save_timeline_variables: true,
                data: jsPsych.timelineVariable('data'),
                on_finish: function(data){
                    data.confidence = data.response;
                    data.task = "reasoning_sd";
                }
            };

            // Confidence in Reasoning
            var confidence_reasoning = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: confidence_r_text,
                choices: ['1','2','3','4','5','6'],
                save_timeline_variables: true,
                data: jsPsych.timelineVariable('data'),
                on_finish: function(data){
                    data.confidence = data.response;
                    data.task = "confidence_reasoning";
                }
            }


            //// Timeline ////
            var timeline = [];
            timeline.push(preload);

            if (tm != 1){
                timeline.push(welcome, consent_info);
                timeline.push(focus);
                timeline.push(fullscreen_start);
                timeline.push(age, gender, language, education);
                timeline.push(resize);
                timeline.push(hidemouse);
            }



            // Practice trials
            var practice_trials = {
                timeline:[fixation, image, mask, scene_diagnostik, confidence_sd, reasoning_sd, confidence_reasoning],
                timeline_variables: practice_stimuli,
                randomize_order: true
            };

            if (tm != 1){
                timeline.push(instructions_pre, practice_trials, endpractice);
            }

            // Main experiment trials
            var experiment_trials = {
                timeline:[instructions, fixation, image, mask, scene_diagnostik, confidence_sd, reasoning_sd, confidence_reasoning],
                timeline_variables: timeline_var,
                randomize_order: true
            };

            timeline.push(experiment_trials);
            timeline.push(save_trial, endscreen, end_fullscreen, endscreen_reminder);

            jsPsych.run(timeline);
            
        </script>
    </body>

</html>